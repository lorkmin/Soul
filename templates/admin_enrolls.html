{% extends "admin_layout.html" %} {% block content %}
<div
  class="top-actions"
  style="
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  "
>
  <div>Всего заявок: {{ enrolls|length }}</div>
  <div>
    <a class="btn-link" href="{{ url_for('admin_enrolls_export') }}"
      >Экспорт в CSV</a
    >
  </div>
</div>

<style>
  /* Бот-бейдж */
  .bot-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    border: 1px solid rgba(0, 0, 0, 0.08);
    background: rgba(0, 0, 0, 0.04);
  }
  .bot-badge.is-bot {
    background: rgba(255, 70, 70, 0.14);
    border-color: rgba(255, 70, 70, 0.35);
  }
  .bot-badge .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.25);
  }
  .bot-badge.is-bot .dot {
    background: rgba(255, 70, 70, 0.9);
  }

  /* Заметки */
  .admin-note-box {
    display: grid;
    gap: 8px;
  }
  .admin-note-input {
    width: 100%;
    min-height: 54px;
    resize: vertical;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.12);
    background: rgba(255, 255, 255, 0.65);
    outline: none;
  }
  .admin-note-input:focus {
    border-color: rgba(90, 48, 165, 0.55);
    box-shadow: 0 0 0 3px rgba(90, 48, 165, 0.12);
  }
  .admin-note-preview {
    margin-top: 6px;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(222, 207, 255, 0.22);
    border: 1px solid rgba(90, 48, 165, 0.18);
    font-size: 0.92rem;
  }

  /* Переключатель "Бот" */
  .bot-toggle {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    user-select: none;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    background: rgba(255, 255, 255, 0.6);
  }
  .bot-toggle input {
    transform: translateY(1px);
  }
  .bot-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
</style>

<table class="admin-table">
  <thead>
    <tr>
      <th>#</th>
      <th>Дата / IP</th>
      <th>Имя / Контакт</th>
      <th>Пакет / Уровень</th>
      <th>Комментарий</th>
      <th>Бот</th>
      <th style="min-width: 340px">Заметка админа</th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    {% for e in enrolls %}
    <tr>
      <td>{{ e.id }}</td>

      <td>
        <div>{{ e.created_at }}</div>
        <div class="admin-meta">{{ e.ip }}</div>
      </td>

      <td>
        <div>{{ e.name }}</div>
        <div class="admin-meta">{{ e.contact }}</div>
      </td>

      <td>
        <div>{{ e.tariff or "—" }}</div>
        <div class="admin-meta">{{ e.level or "—" }}</div>
      </td>

      <td>{{ e.comment or "" }}</td>

      <td style="white-space: nowrap">
        {% if e.is_bot %}
        <span class="bot-badge is-bot"><span class="dot"></span> BOT</span>
        {% else %}
        <span class="bot-badge"><span class="dot"></span> —</span>
        {% endif %}
      </td>

      <td>
        {# ВАЖНО: чекбокс и textarea внутри ЭТОГО ЖЕ form, что и кнопка submit
        #}
        <form
          method="post"
          action="{{ url_for('admin_enroll_note', enroll_id=e.id) }}"
          class="admin-note-box"
        >
          <div class="bot-actions">
            <!-- hidden гарантирует 0 если чекбокс снят -->
            <input type="hidden" name="is_bot" value="0" />

            <label class="bot-toggle">
              <input
                type="checkbox"
                name="is_bot"
                value="1"
                {%
                if
                e.is_bot
                %}checked{%
                endif
                %}
              />
              <span>Пометить как бот</span>
            </label>
          </div>

          <textarea
            class="admin-note-input"
            name="admin_note"
            placeholder="Заметка админа (например: 'бот / спам', 'перезвонить завтра', 'не подходит по времени')"
          >
{{ e.admin_note or "" }}</textarea
          >

          {% if e.admin_note %}
          <div class="admin-note-preview">
            <strong>Текущая заметка:</strong><br />
            {{ e.admin_note }}
          </div>
          {% endif %}

          <div style="display: flex; justify-content: flex-end">
            <button type="submit" class="admin-btn">Сохранить</button>
          </div>
        </form>
      </td>

      <td></td>
    </tr>
    {% else %}
    <tr>
      <td colspan="8">Пока нет заявок.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
