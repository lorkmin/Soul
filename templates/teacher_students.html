{% extends "admin_layout.html" %} {% block content %}

<div class="students-header">
  <div class="admin-header-line">
    <h2>–£—á–µ–Ω–∏–∫–∏</h2>
    <div class="admin-header-actions">
      <a href="{{ url_for('teacher_students_export') }}" class="admin-btn-main admin-btn-outline">
        ‚¨áÔ∏é –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
      </a>

    </div>
  </div>

  <a href="{{ url_for('teacher_students_add') }}" class="admin-btn-main">
    + –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞
  </a>
</div>

<div class="students-controls">
  <div class="students-search">
    <input type="text" id="studentSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, –∫—É—Ä—Å—É –∏–ª–∏ ID‚Ä¶" />
  </div>
  <div class="students-legend">
    <span>–õ–µ–≥–µ–Ω–¥–∞:</span>
    <span class="badge-pill badge-lessons-ok">–º–Ω–æ–≥–æ –∑–∞–Ω—è—Ç–∏–π</span>
    <span class="badge-pill badge-lessons-low">–º–∞–ª–æ</span>
    <span class="badge-pill badge-lessons-critical">–ø–æ—á—Ç–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</span>
  </div>
</div>

{% if students %}
<table class="students-table" id="studentsTable">
  <thead>
    <tr>
      <th>–£—á–µ–Ω–∏–∫</th>
      <th>–ö—É—Ä—Å / ID</th>
      <th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
      <!-- üëà –Ω–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü -->
      <th>–ó–∞–Ω—è—Ç–∏—è</th>
      <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–ª–∞—Ç–∞</th>
      <th style="width: 1%">–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody>
    {% for s in students %} {% set left = s['lessons_left'] %} {% set total =
    s['lessons_total'] %} {% if left is not none and left|int <= 2 %} {% set badge_class="badge-lessons-critical" %} {%
      set badge_text="–∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è" %} {% elif left is not none and left|int <=5 %} {% set
      badge_class="badge-lessons-low" %} {% set badge_text="–º–∞–ª–æ" %} {% elif left is not none %} {% set
      badge_class="badge-lessons-ok" %} {% set badge_text="–æ–∫" %} {% else %} {% set badge_class="badge-status-muted" %}
      {% set badge_text="‚Äî" %} {% endif %} <tr
      data-search="{{ (s['name'] or '')|lower }} {{ (s['course'] or '')|lower }} {{ (s['teacher_name'] or '')|lower }} {{ s['public_code'] }}">
      <td>
        <div class="student-name">{{ s['name'] or "–ë–µ–∑ –∏–º–µ–Ω–∏" }}</div>
        {% if s['comment'] %}
        <div class="student-meta">{{ s['comment'] }}</div>
        {% endif %}
      </td>

      <td>
        {% if s['course'] %}
        <span class="badge-pill badge-course">{{ s['course'] }}</span>
        <br />
        {% endif %}
        <span class="student-code">{{ s['public_code'] }}</span>
      </td>

      <!-- üëá –Ω–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü ¬´–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å¬ª -->
      <td>
        {% if s['teacher_name'] %}
        <div class="student-meta">{{ s['teacher_name'] }}</div>
        {% else %}
        <div class="student-meta student-note">–ù–µ —É–∫–∞–∑–∞–Ω</div>
        {% endif %}
      </td>

      <td>
        <span class="badge-pill {{ badge_class }}"> {{ badge_text }} </span>
        <div class="student-meta">
          {% if total %}–≤—Å–µ–≥–æ {{ total }}{% endif %} {% if total and left is not
          none %} ¬∑ {% endif %} {% if left is not none %}–æ—Å—Ç–∞–ª–æ—Å—å {{ left }}{%
          endif %} {% if not total and left is none %} –Ω–µ —É–∫–∞–∑–∞–Ω–æ {% endif %}
        </div>
      </td>

      <td>
        <div class="student-meta">
          {% if s['last_payment_date'] %} {{ s['last_payment_date'] }} {% else
          %} –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö {% endif %} {% if s['last_payment_amount'] %} ¬∑ {{
          s['last_payment_amount'] }} ‚ÇΩ {% endif %}
        </div>
      </td>

      <td>
        <div class="student-actions">
          <a href="{{ url_for('teacher_student_lessons', sid=s['id']) }}" class="btn-link">
            –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
          </a>
          <a href="{{ url_for('teacher_students_edit', sid=s['id']) }}" class="btn-link">
            –ü—Ä–∞–≤–∫–∞
          </a>
          <form action="{{ url_for('teacher_students_delete', sid=s['id']) }}" method="post"
            onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ –∏ –µ–≥–æ –∑–∞–Ω—è—Ç–∏—è?');" style="margin: 0">
            <button type="submit" class="btn-link btn-link-danger">‚úï</button>
          </form>
        </div>
      </td>
      </tr>
      {% endfor %}
  </tbody>
</table>
{% else %}
<p style="font-size: 0.9rem; color: #777; margin-top: 10px">
  –ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ ‚Äî –º—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –µ–º—É –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π
  6-–∑–Ω–∞—á–Ω—ã–π ID –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ ‚ú®
</p>
{% endif %}

<script>
  (function () {
    const input = document.getElementById("studentSearch");
    const table = document.getElementById("studentsTable");
    if (!input || !table) return;

    const rows = Array.from(table.querySelectorAll("tbody tr"));

    input.addEventListener("input", function () {
      const q = this.value.trim().toLowerCase();
      rows.forEach((row) => {
        const haystack = row.getAttribute("data-search") || "";
        row.style.display = !q || haystack.includes(q) ? "" : "none";
      });
    });
  })();
</script>
{% endblock %}